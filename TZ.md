# Техническое задание
## Telegram-бот для трекинга времени задач

### 1. Общее описание проекта

**Наименование:** Telegram-бот для эффективного трекинга времени задач с интеграцией Jira и расширенной аналитикой производительности

**Цель проекта:** Разработать Telegram-бота для автоматизации учета рабочего времени, позволяющего пользователям отслеживать время выполнения задач, получать аналитику производительности и интегрироваться с системой Jira.

### 2. Функциональные требования

#### 2.1 Основные команды бота

**FR-01: Команда запуска бота**
- Команда: `/start`
- Описание: Инициализация работы с ботом, создание пользователя в базе данных
- Ожидаемое поведение: Отправка приветственного сообщения с описанием возможностей бота и отображение основной клавиатуры

**FR-02: Настройка часового пояса**
- Команда: `/set_timezone <timezone>`
- Описание: Установка часового пояса пользователя для корректного отображения времени
- Параметры: Название часового пояса по стандарту IANA (например, Europe/Moscow)
- Валидация: Проверка корректности введенного часового пояса
- По умолчанию: Europe/Moscow

**FR-03: Настройка рабочего дня**
- Команда: `/set_workday <start_time> <end_time>`
- Описание: Установка границ рабочего дня для автоматического завершения задач
- Параметры: Время начала и окончания в формате HH:MM (например, 09:00 18:00)
- По умолчанию: 09:00-18:00
- Валидация: Проверка корректности формата времени

#### 2.2 Интерфейс пользователя

**FR-04: Основная клавиатура**
- Кнопка "Отдых": Завершение текущей задачи и начало перерыва
- Кнопка "Сводка": Отображение отчета за текущий день
- Кнопка "Помощь": Показ списка всех доступных команд и функций

**FR-05: Справочная система**
- Подробное описание всех команд бота
- Примеры использования
- Описание автоматических функций
- Инструкции по работе с Jira-ссылками

#### 2.3 Трекинг задач

**FR-06: Создание и запуск задач**
- Способ ввода: Отправка текстового сообщения с названием задачи
- Поддержка форматов:
  - Простое название: "Разработка фичи"
  - С указанием времени: "14:00 Название задачи"
  - С комментарием: "Задача - мой комментарий"
  - Jira-ссылки: автоматическое извлечение номера тикета

**FR-07: Обработка времени начала задачи**
- Автоматическое время: Если время не указано, использовать текущее время
- Указанное время: Парсинг времени в формате HH:MM или HH_MM
- Обновление существующей задачи: Если указано то же время, что у активной задачи

**FR-08: Интеграция с Jira**
- Распознавание Jira-ссылок в формате URL
- Извлечение номера тикета из ссылки
- Отображение тикета в удобочитаемом формате

**FR-09: Управление задачами**
- Автоматическое завершение предыдущей задачи при создании новой
- Возможность завершения задачи кнопкой "Отдых"
- Отслеживание времени выполнения каждой задачи

#### 2.4 Функция отдыха

**FR-10: Режим отдыха**
- Завершение текущей активной задачи
- Создание специальной задачи типа "отдых"
- Отображение продолжительности завершенной задачи
- Уведомление о начале отдыха

#### 2.5 Аналитика и отчеты

**FR-11: Дневная сводка**
- Отображение текущей активной задачи с временем начала и продолжительностью
- Список всех задач за день с группировкой по названиям
- Общее время работы (исключая отдых)
- Уникальные комментарии для каждой задачи
- Форматирование времени в удобочитаемом виде

**FR-12: Форматирование отчетов**
- Использование Markdown для выделения важной информации
- Эмодзи для визуального разделения разделов
- Отображение времени в местном часовом поясе пользователя

#### 2.6 Автоматические функции

**FR-13: Автоматическое завершение задач**
- Фоновая задача, выполняющаяся каждые 5 минут
- Проверка активных задач всех пользователей
- Завершение задач по окончании рабочего дня
- Уведомление пользователей о автоматическом завершении

**FR-14: Логика автозавершения**
- Завершение в указанное время окончания рабочего дня
- Для задач, начатых после рабочего дня: завершение в 23:59
- Проверка текущего времени относительно рабочих часов пользователя

### 3. Нефункциональные требования

#### 3.1 Технические требования

**NFR-01: Платформа развертывания**
- Хостинг: Replit
- Язык программирования: Python 3.11
- База данных: PostgreSQL

**NFR-02: Архитектура системы**
- Модульная структура с разделением ответственности
- Слой обработки Telegram API
- Слой бизнес-логики
- Слой работы с данными
- Утилитарные модули для парсинга и форматирования

**NFR-03: Внешние зависимости**
- python-telegram-bot: Взаимодействие с Telegram Bot API
- psycopg2-binary: Подключение к PostgreSQL
- pytz: Обработка часовых поясов
- APScheduler: Планировщик фоновых задач

#### 3.2 Требования к производительности

**NFR-04: Время отклика**
- Время ответа на команды пользователя: не более 3 секунд
- Время генерации дневной сводки: не более 5 секунд

**NFR-05: Масштабируемость**
- Поддержка множественных пользователей
- Изоляция данных между пользователями
- Эффективная работа с базой данных

#### 3.3 Требования к надежности

**NFR-06: Обработка ошибок**
- Graceful handling всех исключений
- Логирование ошибок для диагностики
- Информативные сообщения об ошибках для пользователей

**NFR-07: Непрерывность работы**
- Автоматический перезапуск при сбоях
- Сохранение состояния в базе данных
- Восстановление соединений при потере связи

#### 3.4 Требования к безопасности

**NFR-08: Конфиденциальность данных**
- Изоляция данных пользователей
- Безопасное хранение токена бота
- Использование переменных окружения для конфиденциальной информации

### 4. Требования к данным

#### 4.1 Модель данных пользователей

**DR-01: Таблица users**
- user_id (BIGINT, PRIMARY KEY): Уникальный идентификатор пользователя Telegram
- timezone (VARCHAR(50), DEFAULT 'Europe/Moscow'): Часовой пояс пользователя
- workday_start (TIME, DEFAULT '09:00'): Время начала рабочего дня
- workday_end (TIME, DEFAULT '18:00'): Время окончания рабочего дня
- created_at (TIMESTAMP): Время создания записи

#### 4.2 Модель данных задач

**DR-02: Таблица tasks**
- id (SERIAL, PRIMARY KEY): Уникальный идентификатор задачи
- user_id (BIGINT, FOREIGN KEY): Связь с пользователем
- task_name (VARCHAR(255)): Название задачи
- comment (TEXT, NULLABLE): Комментарий к задаче
- start_time (TIMESTAMP): Время начала задачи в UTC
- end_time (TIMESTAMP, NULLABLE): Время завершения задачи в UTC
- is_rest (BOOLEAN, DEFAULT FALSE): Флаг задачи отдыха

#### 4.3 Требования к целостности данных

**DR-03: Ограничения целостности**
- Уникальность пользователей по user_id
- Обязательность полей user_id, task_name, start_time для задач
- Проверка корректности временных меток

### 5. Требования к интерфейсу

#### 5.1 Пользовательский интерфейс

**UI-01: Принципы взаимодействия**
- Интуитивно понятный интерфейс с кнопками
- Поддержка как команд, так и текстовых сообщений
- Немедленная обратная связь на действия пользователя

**UI-02: Локализация**
- Интерфейс на русском языке
- Форматирование дат и времени согласно российским стандартам
- Использование понятных терминов и сокращений

**UI-03: Обработка ошибок пользователя**
- Валидация пользовательского ввода
- Понятные сообщения об ошибках
- Предложения по исправлению некорректного ввода

### 6. Требования к развертыванию

#### 6.1 Конфигурация окружения

**DEP-01: Переменные окружения**
- BOT_TOKEN: Токен Telegram бота
- DATABASE_URL: Строка подключения к PostgreSQL
- Автоматические переменные от Replit для PostgreSQL

**DEP-02: Инициализация системы**
- Автоматическое создание таблиц при первом запуске
- Проверка подключения к базе данных
- Валидация токена бота

### 7. Требования к логированию и мониторингу

#### 7.1 Логирование

**LOG-01: Уровни логирования**
- INFO: Успешные операции, запуск/остановка системы
- ERROR: Ошибки в работе планировщика, проблемы с базой данных
- WARNING: Некритичные проблемы

**LOG-02: Содержание логов**
- Время выполнения операций
- Детали ошибок для диагностики
- Информация о запуске/остановке компонентов

### 8. Требования к тестированию

#### 8.1 Тестирование функциональности

**TEST-01: Модульное тестирование**
- Тестирование парсинга времени и задач
- Тестирование форматирования данных
- Тестирование логики часовых поясов

**TEST-02: Интеграционное тестирование**
- Тестирование взаимодействия с базой данных
- Тестирование планировщика задач
- Тестирование обработки команд Telegram

### 9. Критерии приемки

#### 9.1 Функциональные критерии

**AC-01: Основная функциональность**
- Пользователь может создавать и отслеживать задачи
- Корректно работает автоматическое завершение задач
- Отображается точная аналитика времени

**AC-02: Удобство использования**
- Интуитивно понятный интерфейс для новых пользователей
- Быстрый отклик на команды
- Информативная справочная система

**AC-03: Надежность**
- Система работает без критических сбоев
- Данные сохраняются корректно
- Планировщик работает стабильно

#### 9.2 Технические критерии

**AC-04: Производительность**
- Время отклика команд не превышает установленных лимитов
- Система поддерживает множественных пользователей
- Эффективное использование ресурсов базы данных

### 10. Риски и ограничения

#### 10.1 Технические риски

**RISK-01: Ограничения Telegram API**
- Лимиты на количество сообщений
- Возможные изменения в API

**RISK-02: Зависимость от внешних сервисов**
- Доступность PostgreSQL
- Стабильность Replit платформы

#### 10.2 Функциональные ограничения

**LIMIT-01: Точность времени**
- Зависимость от системного времени сервера
- Возможные расхождения при смене часовых поясов

**LIMIT-02: Объем данных**
- Ограничения на размер комментариев и названий задач
- Долгосрочное хранение исторических данных

### 11. Техническая документация

#### 11.1 Архитектурные решения

**ARCH-01: Модульная структура**
- Разделение на независимые модули по функциональности
- Четкие интерфейсы между компонентами
- Возможность независимого тестирования модулей

**ARCH-02: Обработка времени**
- Хранение времени в UTC в базе данных
- Конвертация в местное время пользователя при отображении
- Использование timezone-aware объектов datetime

**ARCH-03: Планировщик задач**
- Использование APScheduler для фоновых операций
- Интервальное выполнение каждые 5 минут
- Обработка ошибок без остановки основного процесса

### 12. Заключение

Данное техническое задание определяет полный набор требований для разработки Telegram-бота трекинга времени. Все требования направлены на создание удобного, надежного и масштабируемого решения для автоматизации учета рабочего времени с интеграцией современных инструментов разработки.

Успешная реализация всех перечисленных требований обеспечит пользователям эффективный инструмент для повышения продуктивности и контроля рабочего времени.